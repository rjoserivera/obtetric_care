{% extends 'Shared/base.html' %}
{% load static %}

{% block title %}Asignar Rol: Paciente - Sistema Obstétrico{% endblock %}

{% block content %}
<div class="container mt-4">
    
    <!-- Información de la Persona -->
    <div class="card mb-3 border-dark">
        <div class="card-header bg-dark text-white">
            <h5 class="mb-0">
                <i class="bi bi-person-badge"></i> Asignar Rol: Paciente
            </h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <p class="mb-1"><strong>RUT:</strong> {{ persona.Rut }}</p>
                    <p class="mb-0"><strong>Nombre:</strong> {{ persona.Nombre }} {{ persona.Apellido_Paterno }} {{ persona.Apellido_Materno }}</p>
                </div>
                <div class="col-md-6">
                    <p class="mb-1"><strong>Sexo:</strong> {{ persona.get_Sexo_display }}</p>
                    <p class="mb-0"><strong>Fecha Nacimiento:</strong> {{ persona.Fecha_nacimiento|date:"d/m/Y" }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Formulario de Datos del Paciente -->
    <form method="post" id="formAsignarPaciente">
        {% csrf_token %}
        
        <!-- Errores globales -->
        {% if form.errors %}
        <div class="alert alert-danger">
            <h6><i class="bi bi-exclamation-triangle"></i> Errores en el formulario:</h6>
            {{ form.errors }}
        </div>
        {% endif %}

        <!-- Datos del Rol Paciente -->
        <div class="card mb-3 shadow-sm">
            <div class="card-header bg-danger text-white">
                <h5 class="mb-0">
                    <i class="bi bi-clipboard-heart"></i> Datos del Rol Paciente
                </h5>
            </div>
            <div class="card-body">
                
                <!-- SECCIÓN: Información Básica -->
                <div class="card mb-3 bg-light">
                    <div class="card-body">
                        <h6 class="text-danger mb-3">
                            <i class="bi bi-person-fill"></i> Información Básica del Paciente
                        </h6>
                        
                        <div class="row">
                            <!-- Estado Civil -->
                            <div class="col-md-6 mb-3">
                                <label for="id_estado_civil" class="form-label">
                                    Estado Civil <span class="text-danger">*</span>
                                </label>
                                <select class="form-select {% if form.Estado_civil.errors %}is-invalid{% endif %}" 
                                        id="id_estado_civil" 
                                        name="Estado_civil"
                                        required>
                                    <option value="">---------</option>
                                    <option value="SOLTERA" {% if form.Estado_civil.value == 'SOLTERA' %}selected{% endif %}>Soltera</option>
                                    <option value="CASADA" {% if form.Estado_civil.value == 'CASADA' %}selected{% endif %}>Casada</option>
                                    <option value="CONVIVIENTE" {% if form.Estado_civil.value == 'CONVIVIENTE' %}selected{% endif %}>Conviviente</option>
                                    <option value="DIVORCIADA" {% if form.Estado_civil.value == 'DIVORCIADA' %}selected{% endif %}>Divorciada</option>
                                    <option value="VIUDA" {% if form.Estado_civil.value == 'VIUDA' %}selected{% endif %}>Viuda</option>
                                </select>
                                {% if form.Estado_civil.errors %}
                                    <div class="invalid-feedback">{{ form.Estado_civil.errors.0 }}</div>
                                {% endif %}
                            </div>

                            <!-- Previsión -->
                            <div class="col-md-6 mb-3">
                                <label for="id_prevision" class="form-label">
                                    Previsión <span class="text-danger">*</span>
                                </label>
                                <select class="form-select {% if form.Previcion.errors %}is-invalid{% endif %}" 
                                        id="id_prevision" 
                                        name="Previcion"
                                        required>
                                    <option value="">---------</option>
                                    <option value="FONASA_A" {% if form.Previcion.value == 'FONASA_A' %}selected{% endif %}>FONASA A</option>
                                    <option value="FONASA_B" {% if form.Previcion.value == 'FONASA_B' %}selected{% endif %}>FONASA B</option>
                                    <option value="FONASA_C" {% if form.Previcion.value == 'FONASA_C' %}selected{% endif %}>FONASA C</option>
                                    <option value="FONASA_D" {% if form.Previcion.value == 'FONASA_D' %}selected{% endif %}>FONASA D</option>
                                    <option value="ISAPRE" {% if form.Previcion.value == 'ISAPRE' %}selected{% endif %}>Isapre</option>
                                    <option value="PARTICULAR" {% if form.Previcion.value == 'PARTICULAR' %}selected{% endif %}>Particular</option>
                                </select>
                                {% if form.Previcion.errors %}
                                    <div class="invalid-feedback">{{ form.Previcion.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SECCIÓN: Antecedentes Obstétricos -->
                <div class="card mb-3 bg-light">
                    <div class="card-body">
                        <h6 class="text-danger mb-3">
                            <i class="bi bi-heart-pulse"></i> Antecedentes Obstétricos
                        </h6>
                        
                        <div class="row">
                            <!-- Paridad -->
                            <div class="col-md-12 mb-3">
                                <label for="id_paridad" class="form-label">
                                    Paridad
                                </label>
                                <input type="text" 
                                       class="form-control {% if form.paridad.errors %}is-invalid{% endif %}" 
                                       id="id_paridad" 
                                       name="paridad"
                                       value="{{ form.paridad.value|default:'' }}"
                                       placeholder="Ejemplo: G3P2A0">
                                <small class="form-text text-muted">
                                    Formato: G (Gestas) P (Partos) A (Abortos). Ej: G3P2A0
                                </small>
                                {% if form.paridad.errors %}
                                    <div class="invalid-feedback">{{ form.paridad.errors.0 }}</div>
                                {% endif %}
                            </div>

                            <!-- Control Prenatal -->
                            <div class="col-md-12 mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" 
                                           type="checkbox" 
                                           id="id_control_prenatal" 
                                           name="control_prenatal"
                                           {% if form.control_prenatal.value %}checked{% endif %}>
                                    <label class="form-check-label" for="id_control_prenatal">
                                        ¿Tuvo Control Prenatal?
                                    </label>
                                </div>
                            </div>

                            <!-- Ductus Venosus -->
                            <div class="col-md-12 mb-3">
                                <label for="id_ductus_venosus" class="form-label">
                                    Ductus Venosus
                                </label>
                                <select class="form-select {% if form.Ductus_Venosus.errors %}is-invalid{% endif %}" 
                                        id="id_ductus_venosus" 
                                        name="Ductus_Venosus">
                                    <option value="SIN_ESPECIFICAR" {% if form.Ductus_Venosus.value == 'SIN_ESPECIFICAR' %}selected{% endif %}>Sin Especificar</option>
                                    <option value="DUCTUS_VENOSUS" {% if form.Ductus_Venosus.value == 'DUCTUS_VENOSUS' %}selected{% endif %}>Ductus Venosus</option>
                                    <option value="DUCTUS_VENOSUS_SIN_CONTROL" {% if form.Ductus_Venosus.value == 'DUCTUS_VENOSUS_SIN_CONTROL' %}selected{% endif %}>Ductus Venosus Sin Control</option>
                                    <option value="DUCTUS_VENOSUS_CONTROL" {% if form.Ductus_Venosus.value == 'DUCTUS_VENOSUS_CONTROL' %}selected{% endif %}>Ductus Venosus Con Control</option>
                                    <option value="DUCTUS_VENOSUS_CONTROL_SIN_PREVENCION" {% if form.Ductus_Venosus.value == 'DUCTUS_VENOSUS_CONTROL_SIN_PREVENCION' %}selected{% endif %}>Con Control Sin Prevención</option>
                                    <option value="DUCTUS_VENOSUS_CONTROL_PREVENCION" {% if form.Ductus_Venosus.value == 'DUCTUS_VENOSUS_CONTROL_PREVENCION' %}selected{% endif %}>Con Control Con Prevención</option>
                                </select>
                                {% if form.Ductus_Venosus.errors %}
                                    <div class="invalid-feedback">{{ form.Ductus_Venosus.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SECCIÓN: Datos del Consultorio -->
                <div class="card mb-3 bg-light">
                    <div class="card-body">
                        <h6 class="text-danger mb-3">
                            <i class="bi bi-hospital"></i> Centro de Salud
                        </h6>
                        
                        <div class="row">
                            <!-- Consultorio de Origen -->
                            <div class="col-md-12 mb-3">
                                <label for="id_consultorio" class="form-label">
                                    Consultorio / CESFAM de Origen
                                </label>
                                <select class="form-select {% if form.consultorio_inscrito.errors %}is-invalid{% endif %}" 
                                        id="id_consultorio" 
                                        name="consultorio_inscrito">
                                    <option value="SIN_ESPECIFICAR">Sin Especificar</option>
                                    <option value="CESFAM_ULTRAESTACION_DR_RAUL_SAN_MARTIN">CESFAM Ultraestación Dr. Raúl San Martín (Chillán)</option>
                                    <option value="CESFAM_LOS_VOLCANES">CESFAM Los Volcanes (Chillán)</option>
                                    <option value="CESFAM_ISABEL_RIQUELME">CESFAM Isabel Riquelme (Chillán)</option>
                                    <option value="CESFAM_QUINCHAMALI">CESFAM Quinchamalí (Chillán)</option>
                                    <option value="CESFAM_TERESA_BALDECHI">CESFAM Teresa Baldechi (San Carlos)</option>
                                    <option value="CESFAM_DR_ALBERTO_GYHRA_SOTO">CESFAM Dr. Alberto Gyhra Soto (Quillón)</option>
                                    <option value="CESFAM_MICHELL_CHANDIA_ALARCON">CESFAM Michell Chandia Alarcon (Coihueco)</option>
                                </select>
                                {% if form.consultorio_inscrito.errors %}
                                    <div class="invalid-feedback">{{ form.consultorio_inscrito.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SECCIÓN: Información de Peso y Talla -->
                <div class="card mb-3 bg-light">
                    <div class="card-body">
                        <h6 class="text-danger mb-3">
                            <i class="bi bi-activity"></i> Datos Antropométricos
                        </h6>
                        
                        <div class="row">
                            <!-- Peso -->
                            <div class="col-md-4 mb-3">
                                <label for="id_peso" class="form-label">
                                    Peso (kg)
                                </label>
                                <input type="number" 
                                       step="0.1"
                                       class="form-control {% if form.peso.errors %}is-invalid{% endif %}" 
                                       id="id_peso" 
                                       name="peso"
                                       value="{{ form.peso.value|default:'' }}"
                                       placeholder="65.5"
                                       min="30"
                                       max="200">
                                {% if form.peso.errors %}
                                    <div class="invalid-feedback">{{ form.peso.errors.0 }}</div>
                                {% endif %}
                            </div>

                            <!-- Talla -->
                            <div class="col-md-4 mb-3">
                                <label for="id_talla" class="form-label">
                                    Talla (cm)
                                </label>
                                <input type="number" 
                                       step="0.1"
                                       class="form-control {% if form.talla.errors %}is-invalid{% endif %}" 
                                       id="id_talla" 
                                       name="talla"
                                       value="{{ form.talla.value|default:'' }}"
                                       placeholder="165"
                                       min="100"
                                       max="220">
                                {% if form.talla.errors %}
                                    <div class="invalid-feedback">{{ form.talla.errors.0 }}</div>
                                {% endif %}
                            </div>

                            <!-- IMC (calculado automáticamente) -->
                            <div class="col-md-4 mb-3">
                                <label for="id_imc" class="form-label">
                                    IMC (Índice de Masa Corporal)
                                </label>
                                <input type="number" 
                                       step="0.01"
                                       class="form-control" 
                                       id="id_imc" 
                                       name="imc"
                                       value="{{ form.imc.value|default:'' }}"
                                       readonly>
                                <small class="form-text text-muted" id="imc_categoria"></small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SECCIÓN: Contacto de Emergencia -->
                <div class="card mb-3 bg-light">
                    <div class="card-body">
                        <h6 class="text-danger mb-3">
                            <i class="bi bi-telephone-forward"></i> Contacto de Emergencia
                        </h6>
                        
                        <div class="row">
                            <!-- Nombre del Acompañante -->
                            <div class="col-md-6 mb-3">
                                <label for="id_acompanante" class="form-label">
                                    Nombre del Acompañante
                                </label>
                                <input type="text" 
                                       class="form-control {% if form.Acompañante.errors %}is-invalid{% endif %}" 
                                       id="id_acompanante" 
                                       name="Acompañante"
                                       value="{{ form.Acompañante.value|default:'' }}"
                                       placeholder="Nombre completo del acompañante"
                                       maxlength="200">
                                {% if form.Acompañante.errors %}
                                    <div class="invalid-feedback">{{ form.Acompañante.errors.0 }}</div>
                                {% endif %}
                            </div>

                            <!-- Contacto de Emergencia -->
                            <div class="col-md-6 mb-3">
                                <label for="id_contacto_emergencia" class="form-label">
                                    Contacto de Emergencia <span class="text-danger">*</span>
                                </label>
                                <input type="tel" 
                                       class="form-control {% if form.Contacto_emergencia.errors %}is-invalid{% endif %}" 
                                       id="id_contacto_emergencia" 
                                       name="Contacto_emergencia"
                                       value="{{ form.Contacto_emergencia.value|default:'' }}"
                                       placeholder="+56912345678"
                                       required
                                       maxlength="15">
                                <small class="form-text text-muted">
                                    Teléfono de contacto en caso de emergencia
                                </small>
                                {% if form.Contacto_emergencia.errors %}
                                    <div class="invalid-feedback">{{ form.Contacto_emergencia.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Botones de Acción -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <button type="submit" class="btn btn-danger btn-lg w-100">
                            <i class="bi bi-check-circle"></i> Asignar Rol Paciente
                        </button>
                    </div>
                    <div class="col-md-6">
                        <a href="{% url 'gestion:detalle_persona' persona.pk %}" class="btn btn-secondary btn-lg w-100">
                            <i class="bi bi-arrow-left"></i> Volver
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Nota Informativa -->
        <div class="alert alert-info">
            <i class="bi bi-info-circle"></i>
            <strong>Nota:</strong> Una persona puede tener múltiples roles simultáneamente. 
            Puede asignar más roles desde la gestión de roles.
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Calcular IMC automáticamente
function calcularIMC() {
    const peso = parseFloat(document.getElementById('id_peso').value);
    const talla = parseFloat(document.getElementById('id_talla').value) / 100; // Convertir cm a metros
    
    if (peso && talla && talla > 0) {
        const imc = peso / (talla * talla);
        document.getElementById('id_imc').value = imc.toFixed(2);
        
        // Categoría del IMC
        let categoria = '';
        let color = '';
        
        if (imc < 18.5) {
            categoria = 'Bajo peso';
            color = 'text-warning';
        } else if (imc >= 18.5 && imc < 25) {
            categoria = 'Normal';
            color = 'text-success';
        } else if (imc >= 25 && imc < 30) {
            categoria = 'Sobrepeso';
            color = 'text-warning';
        } else {
            categoria = 'Obesidad';
            color = 'text-danger';
        }
        
        document.getElementById('imc_categoria').innerHTML = `<span class="${color}">${categoria}</span>`;
    }
}

// Agregar eventos
document.getElementById('id_peso')?.addEventListener('input', calcularIMC);
document.getElementById('id_talla')?.addEventListener('input', calcularIMC);

// Calcular al cargar si ya hay valores
document.addEventListener('DOMContentLoaded', calcularIMC);

// Validar formulario
document.getElementById('formAsignarPaciente').addEventListener('submit', function(e) {
    const estadoCivil = document.getElementById('id_estado_civil').value;
    const prevision = document.getElementById('id_prevision').value;
    const contactoEmergencia = document.getElementById('id_contacto_emergencia').value;
    
    if (!estadoCivil || !prevision || !contactoEmergencia) {
        e.preventDefault();
        alert('❌ Por favor complete todos los campos obligatorios (Estado Civil, Previsión y Contacto de Emergencia)');
        return false;
    }
});

console.log('✅ Formulario de asignar rol paciente cargado');
</script>
{% endblock %}