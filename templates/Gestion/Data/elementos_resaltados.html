{% extends 'Shared/base.html' %}
{% load static %}

{% block title %}Elementos Destacados - Sistema Obstétrico{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="card shadow">
        <div class="card-header bg-primary text-white">
            <div class="d-flex justify-content-between align-items-center">
                <h4 class="mb-0">
                    <i class="bi bi-star-fill"></i> Elementos Destacados del Sistema
                </h4>
                <span class="badge bg-light text-dark">
                    <i class="bi bi-clock"></i> {{ fecha_actual|date:"d/m/Y H:i" }}
                </span>
            </div>
        </div>
        
        <div class="card-body">
            <!-- Alertas Críticas -->
            <div class="mb-4">
                <h5 class="text-danger border-bottom pb-2">
                    <i class="bi bi-exclamation-triangle-fill"></i> Alertas Críticas
                </h5>
                {% if alertas_criticas %}
                <div class="row">
                    {% for alerta in alertas_criticas %}
                    <div class="col-md-6 mb-3">
                        <div class="alert alert-danger" role="alert">
                            <h6 class="alert-heading">
                                <i class="bi bi-exclamation-circle"></i> {{ alerta.titulo }}
                            </h6>
                            <p class="mb-2">{{ alerta.descripcion }}</p>
                            <hr>
                            <div class="d-flex justify-content-between align-items-center">
                                <small class="text-muted">
                                    <i class="bi bi-calendar"></i> {{ alerta.fecha|date:"d/m/Y H:i" }}
                                </small>
                                <a href="{{ alerta.url }}" class="btn btn-sm btn-danger">
                                    Ver Detalle <i class="bi bi-arrow-right"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="alert alert-success">
                    <i class="bi bi-check-circle"></i> No hay alertas críticas en este momento
                </div>
                {% endif %}
            </div>

            <!-- Pacientes de Alto Riesgo -->
            <div class="mb-4">
                <h5 class="text-warning border-bottom pb-2">
                    <i class="bi bi-heart-pulse-fill"></i> Pacientes de Alto Riesgo
                </h5>
                {% if pacientes_alto_riesgo %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-warning">
                            <tr>
                                <th>RUT</th>
                                <th>Nombre</th>
                                <th>Edad Gestacional</th>
                                <th>Factor de Riesgo</th>
                                <th>Último Control</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for paciente in pacientes_alto_riesgo %}
                            <tr>
                                <td><strong>{{ paciente.rut }}</strong></td>
                                <td>{{ paciente.nombre_completo }}</td>
                                <td>
                                    <span class="badge bg-info">{{ paciente.edad_gestacional }} sem</span>
                                </td>
                                <td>
                                    <span class="badge bg-warning text-dark">{{ paciente.factor_riesgo }}</span>
                                </td>
                                <td>{{ paciente.ultimo_control|date:"d/m/Y" }}</td>
                                <td>
                                    <a href="{{ paciente.url_ficha }}" class="btn btn-sm btn-outline-warning">
                                        <i class="bi bi-eye"></i> Ver Ficha
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> No hay pacientes de alto riesgo registradas
                </div>
                {% endif %}
            </div>

            <!-- Controles Pendientes Urgentes -->
            <div class="mb-4">
                <h5 class="text-info border-bottom pb-2">
                    <i class="bi bi-calendar-check-fill"></i> Controles Pendientes Urgentes
                </h5>
                {% if controles_urgentes %}
                <div class="row">
                    {% for control in controles_urgentes %}
                    <div class="col-md-4 mb-3">
                        <div class="card border-info">
                            <div class="card-body">
                                <h6 class="card-title text-info">
                                    <i class="bi bi-person"></i> {{ control.paciente_nombre }}
                                </h6>
                                <p class="card-text small">
                                    <strong>RUT:</strong> {{ control.paciente_rut }}<br>
                                    <strong>Tipo:</strong> {{ control.tipo_control }}<br>
                                    <strong>Fecha Programada:</strong> {{ control.fecha|date:"d/m/Y" }}
                                </p>
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="badge bg-danger">
                                        <i class="bi bi-exclamation"></i> Urgente
                                    </span>
                                    <a href="{{ control.url }}" class="btn btn-sm btn-info">
                                        Atender
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="alert alert-success">
                    <i class="bi bi-check-circle"></i> No hay controles urgentes pendientes
                </div>
                {% endif %}
            </div>

            <!-- Fichas Incompletas -->
            <div class="mb-4">
                <h5 class="text-secondary border-bottom pb-2">
                    <i class="bi bi-file-earmark-medical"></i> Fichas Obstétricas Incompletas
                </h5>
                {% if fichas_incompletas %}
                <div class="row">
                    {% for ficha in fichas_incompletas %}
                    <div class="col-md-6 mb-3">
                        <div class="card border-secondary">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h6 class="card-title">
                                            <i class="bi bi-person"></i> {{ ficha.paciente_nombre }}
                                        </h6>
                                        <p class="card-text small mb-2">
                                            <strong>RUT:</strong> {{ ficha.paciente_rut }}<br>
                                            <strong>Edad Gestacional:</strong> {{ ficha.edad_gestacional }} semanas
                                        </p>
                                        <div class="mb-2">
                                            <small class="text-muted">Campos faltantes:</small>
                                            <div class="mt-1">
                                                {% for campo in ficha.campos_faltantes %}
                                                <span class="badge bg-secondary me-1">{{ campo }}</span>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </div>
                                    <span class="badge bg-warning text-dark">
                                        {{ ficha.porcentaje_completitud }}%
                                    </span>
                                </div>
                                <a href="{{ ficha.url }}" class="btn btn-sm btn-outline-secondary w-100 mt-2">
                                    <i class="bi bi-pencil"></i> Completar Ficha
                                </a>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="alert alert-success">
                    <i class="bi bi-check-circle"></i> Todas las fichas están completas
                </div>
                {% endif %}
            </div>

            <!-- Resumen General -->
            <div class="row">
                <div class="col-md-12">
                    <h5 class="text-primary border-bottom pb-2">
                        <i class="bi bi-bar-chart-fill"></i> Resumen General del Sistema
                    </h5>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card border-danger">
                        <div class="card-body text-center">
                            <h3 class="text-danger mb-0">{{ stats.alertas_totales }}</h3>
                            <small class="text-muted">Alertas Activas</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card border-warning">
                        <div class="card-body text-center">
                            <h3 class="text-warning mb-0">{{ stats.pacientes_alto_riesgo }}</h3>
                            <small class="text-muted">Alto Riesgo</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card border-info">
                        <div class="card-body text-center">
                            <h3 class="text-info mb-0">{{ stats.controles_urgentes }}</h3>
                            <small class="text-muted">Controles Urgentes</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card border-secondary">
                        <div class="card-body text-center">
                            <h3 class="text-secondary mb-0">{{ stats.fichas_incompletas }}</h3>
                            <small class="text-muted">Fichas Incompletas</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card-footer bg-light">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <small class="text-muted">
                        <i class="bi bi-info-circle"></i> 
                        Los elementos destacados se actualizan automáticamente cada 5 minutos
                    </small>
                </div>
                <div>
                    <a href="{% url 'home' %}" class="btn btn-secondary btn-sm">
                        <i class="bi bi-arrow-left"></i> Volver al Inicio
                    </a>
                    <button onclick="location.reload()" class="btn btn-primary btn-sm">
                        <i class="bi bi-arrow-clockwise"></i> Actualizar
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Auto-refresh cada 5 minutos
setTimeout(function() {
    location.reload();
}, 300000);

console.log('✅ Elementos destacados cargados:', {
    alertas: {{ stats.alertas_totales }},
    alto_riesgo: {{ stats.pacientes_alto_riesgo }},
    controles_urgentes: {{ stats.controles_urgentes }},
    fichas_incompletas: {{ stats.fichas_incompletas }}
});
</script>
{% endblock %}
