{% extends 'Shared/base.html' %}
{% load static %}

{% block title %}Crear Ficha Obst√©trica - Sistema Obst√©trico{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Encabezado -->
    <div class="row mb-4">
        <div class="col-12">
            <h2 class="text-primary">
                <i class="bi bi-file-medical-fill"></i> Nueva Ficha Obst√©trica
            </h2>
            <hr>
        </div>
    </div>

    <!-- Informaci√≥n del Paciente -->
    <div class="card mb-4 border-primary">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="bi bi-person-circle"></i> Datos del Paciente</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <p><strong>RUT:</strong> {{ paciente.persona.Rut }}</p>
                    <p><strong>Nombre:</strong> {{ paciente.persona.Nombre }} {{ paciente.persona.Apellido_Paterno }}</p>
                </div>
                <div class="col-md-4">
                    <p><strong>Edad:</strong> {{ paciente.Edad }} a√±os</p>
                    <p><strong>Fecha Nac:</strong> {{ paciente.persona.Fecha_nacimiento|date:"d/m/Y" }}</p>
                </div>
                <div class="col-md-4">
                    <p><strong>Tel√©fono:</strong> {{ paciente.persona.Telefono|default:"No registrado" }}</p>
                    <p><strong>Email:</strong> {{ paciente.persona.Email|default:"No registrado" }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Formulario de Ficha Obst√©trica -->
    <div class="card shadow-sm">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0"><i class="bi bi-clipboard-pulse"></i> Datos de la Ficha Obst√©trica</h5>
        </div>
        <div class="card-body">
            <form method="post" id="formCrearFicha">
                {% csrf_token %}
                
                <!-- Mostrar errores si existen -->
                {% if form.errors %}
                <div class="alert alert-danger" role="alert">
                    <h5><i class="bi bi-exclamation-triangle"></i> Corrija los siguientes errores:</h5>
                    {{ form.errors }}
                </div>
                {% endif %}

                <!-- Datos Obst√©tricos Principales -->
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h6 class="mb-0">üìã Informaci√≥n Obst√©trica</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <!-- Edad Gestacional -->
                            <div class="col-md-6 mb-3">
                                <label for="id_edad_gestacional" class="form-label">
                                    Edad Gestacional (semanas) <span class="text-danger">*</span>
                                </label>
                                {{ form.edad_gestacional }}
                                <small class="form-text text-muted">Semanas de embarazo (0-42)</small>
                            </div>

                            <!-- Fecha √öltima Menstruaci√≥n -->
                            <div class="col-md-6 mb-3">
                                <label for="id_fecha_ultima_menstruacion" class="form-label">
                                    Fecha √öltima Menstruaci√≥n (FUM) <span class="text-danger">*</span>
                                </label>
                                {{ form.fecha_ultima_menstruacion }}
                            </div>

                            <!-- Fecha Probable Parto -->
                            <div class="col-md-6 mb-3">
                                <label for="id_fecha_probable_parto" class="form-label">
                                    Fecha Probable de Parto (FPP) <span class="text-danger">*</span>
                                </label>
                                {{ form.fecha_probable_parto }}
                            </div>

                            <!-- Grupo Sangu√≠neo -->
                            <div class="col-md-6 mb-3">
                                <label for="id_grupo_sanguineo" class="form-label">
                                    Grupo Sangu√≠neo <span class="text-danger">*</span>
                                </label>
                                {{ form.grupo_sanguineo }}
                            </div>

                            <!-- Factor RH -->
                            <div class="col-md-6 mb-3">
                                <label for="id_factor_rh" class="form-label">
                                    Factor RH <span class="text-danger">*</span>
                                </label>
                                {{ form.factor_rh }}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Antecedentes Obst√©tricos -->
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h6 class="mb-0">ü§∞ Antecedentes Obst√©tricos</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <!-- N√∫mero de Embarazos -->
                            <div class="col-md-3 mb-3">
                                <label for="id_numero_embarazos" class="form-label">
                                    N¬∞ Embarazos (G)
                                </label>
                                {{ form.numero_embarazos }}
                            </div>

                            <!-- Partos -->
                            <div class="col-md-3 mb-3">
                                <label for="id_partos" class="form-label">
                                    Partos (P)
                                </label>
                                {{ form.partos }}
                            </div>

                            <!-- Ces√°reas -->
                            <div class="col-md-3 mb-3">
                                <label for="id_cesareas" class="form-label">
                                    Ces√°reas (C)
                                </label>
                                {{ form.cesareas }}
                            </div>

                            <!-- Abortos -->
                            <div class="col-md-3 mb-3">
                                <label for="id_abortos" class="form-label">
                                    Abortos (A)
                                </label>
                                {{ form.abortos }}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Patolog√≠as -->
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h6 class="mb-0">‚öïÔ∏è Patolog√≠as Asociadas</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-12 mb-3">
                                <label for="id_patologias" class="form-label">
                                    Seleccione patolog√≠as (puede seleccionar m√∫ltiples)
                                </label>
                                {{ form.patologias }}
                                <small class="form-text text-muted">
                                    Mantenga presionado Ctrl (o Cmd en Mac) para seleccionar m√∫ltiples opciones
                                </small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Observaciones Generales -->
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h6 class="mb-0">üìù Observaciones</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-12 mb-3">
                                <label for="id_observaciones" class="form-label">
                                    Observaciones Generales
                                </label>
                                {{ form.observaciones }}
                                <small class="form-text text-muted">
                                    Antecedentes relevantes, alergias, observaciones especiales, etc.
                                </small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Botones de Acci√≥n -->
                <div class="row mt-4">
                    <div class="col-12">
                        <button type="submit" class="btn btn-success btn-lg">
                            <i class="bi bi-check-circle"></i> Crear Ficha Obst√©trica
                        </button>
                        <a href="{% url 'matrona:lista_fichas_paciente' paciente.pk %}" class="btn btn-secondary btn-lg">
                            <i class="bi bi-x-circle"></i> Cancelar
                        </a>
                        <button type="reset" class="btn btn-outline-warning btn-lg">
                            <i class="bi bi-arrow-clockwise"></i> Limpiar Formulario
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Notas Informativas -->
    <div class="alert alert-info mt-4" role="alert">
        <h6><i class="bi bi-info-circle"></i> Informaci√≥n Importante</h6>
        <ul class="mb-0">
            <li>Los campos marcados con <span class="text-danger">*</span> son obligatorios</li>
            <li>La Fecha Probable de Parto se calcula sumando 280 d√≠as a la FUM</li>
            <li>Puede agregar medicamentos y m√°s detalles despu√©s de crear la ficha</li>
        </ul>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Calcular FPP autom√°ticamente al ingresar FUM
document.getElementById('id_fecha_ultima_menstruacion')?.addEventListener('change', function() {
    const fum = new Date(this.value);
    if (fum) {
        // Agregar 280 d√≠as (40 semanas)
        const fpp = new Date(fum.getTime() + (280 * 24 * 60 * 60 * 1000));
        const fppInput = document.getElementById('id_fecha_probable_parto');
        if (fppInput) {
            fppInput.value = fpp.toISOString().split('T')[0];
        }
    }
});

// Validaci√≥n de formulario
document.getElementById('formCrearFicha').addEventListener('submit', function(e) {
    const edadGestacional = parseInt(document.getElementById('id_edad_gestacional')?.value);
    
    if (edadGestacional && (edadGestacional < 0 || edadGestacional > 42)) {
        e.preventDefault();
        alert('‚ùå La edad gestacional debe estar entre 0 y 42 semanas');
        return false;
    }
});

console.log('‚úÖ Formulario de crear ficha cargado');
</script>
{% endblock %}