{% extends 'Shared/base.html' %}
{% load static %}

{% block title %}Crear Ficha Obstétrica - Sistema Obstétrico{% endblock %}

{% block content %}
<div class="container mt-4">
    
    <!-- ============================================
         SECCIÓN: Navegación (Breadcrumb)
         ============================================ -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                <a href="{% url 'matrona:menu_matrona' %}">
                    <i class="bi bi-house-fill"></i> Menú Matrona
                </a>
            </li>
            <li class="breadcrumb-item">
                <a href="{% url 'matrona:detalle_paciente' paciente.pk %}">
                    {{ paciente.persona.Nombre }} {{ paciente.persona.Apellido_Paterno }}
                </a>
            </li>
            <li class="breadcrumb-item active" aria-current="page">
                Nueva Ficha Obstétrica
            </li>
        </ol>
    </nav>

    <!-- ============================================
         SECCIÓN: Encabezado
         ============================================ -->
    <div class="row mb-4">
        <div class="col-12">
            <h2 class="text-primary">
                <i class="bi bi-file-earmark-medical"></i> Crear Nueva Ficha Obstétrica
            </h2>
            <p class="text-muted">
                Complete los datos del embarazo actual de la paciente
            </p>
        </div>
    </div>

    <div class="row">
        <!-- ============================================
             COLUMNA IZQUIERDA: Información del Paciente
             Card con datos básicos de la paciente
             ============================================ -->
        <div class="col-lg-4 mb-4">
            <div class="card shadow-sm sticky-top" style="top: 20px;">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-person-fill"></i> Datos del Paciente
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Información básica del paciente -->
                    <div class="mb-3">
                        <label class="text-muted small mb-1">Nombre Completo:</label>
                        <p class="mb-0 fw-bold">
                            {{ paciente.persona.Nombre }} 
                            {{ paciente.persona.Apellido_Paterno }} 
                            {{ paciente.persona.Apellido_Materno }}
                        </p>
                    </div>

                    <div class="mb-3">
                        <label class="text-muted small mb-1">RUT:</label>
                        <p class="mb-0 fw-bold">
                            <i class="bi bi-card-text"></i> {{ paciente.persona.Rut }}
                        </p>
                    </div>

                    <div class="mb-3">
                        <label class="text-muted small mb-1">Edad:</label>
                        <p class="mb-0">
                            {% if paciente.Edad %}
                                {{ paciente.Edad }} años
                            {% else %}
                                <span class="text-muted">No registrada</span>
                            {% endif %}
                        </p>
                    </div>

                    <div class="mb-3">
                        <label class="text-muted small mb-1">Estado Civil:</label>
                        <p class="mb-0">
                            {{ paciente.Estado_civil|default:"No especificado" }}
                        </p>
                    </div>

                    <div class="mb-3">
                        <label class="text-muted small mb-1">Previsión:</label>
                        <p class="mb-0">
                            <span class="badge bg-info">
                                {{ paciente.Previcion|default:"No especificada" }}
                            </span>
                        </p>
                    </div>

                    <div class="mb-3">
                        <label class="text-muted small mb-1">Contacto de Emergencia:</label>
                        <p class="mb-0">
                            <i class="bi bi-telephone-fill text-danger"></i>
                            {{ paciente.Contacto_emergencia|default:"No registrado" }}
                        </p>
                    </div>

                    <hr>

                    <!-- Botones de acceso rápido -->
                    <div class="d-grid gap-2">
                        <a href="{% url 'matrona:detalle_paciente' paciente.pk %}" 
                           class="btn btn-sm btn-outline-info">
                            <i class="bi bi-eye"></i> Ver Perfil Completo
                        </a>
                        <a href="{% url 'matrona:lista_fichas_paciente' paciente.pk %}" 
                           class="btn btn-sm btn-outline-primary">
                            <i class="bi bi-folder"></i> Ver Fichas Anteriores
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- ============================================
             COLUMNA DERECHA: Formulario de Ficha Obstétrica
             ============================================ -->
        <div class="col-lg-8">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-clipboard2-pulse"></i> Datos de la Ficha Obstétrica
                    </h5>
                </div>
                <div class="card-body">
                    
                    <!-- Mostrar mensajes de error si existen -->
                    {% if form.errors %}
                        <div class="alert alert-danger" role="alert">
                            <i class="bi bi-exclamation-triangle-fill"></i>
                            <strong>¡Error en el formulario!</strong>
                            <p class="mb-0 mt-2">Por favor corrija los siguientes errores:</p>
                            <ul class="mb-0 mt-2">
                                {% for field, errors in form.errors.items %}
                                    {% for error in errors %}
                                        <li>{{ error }}</li>
                                    {% endfor %}
                                {% endfor %}
                            </ul>
                        </div>
                    {% endif %}

                    <!-- Formulario Django -->
                    <form method="POST" id="formFichaObstetrica">
                        {% csrf_token %}
                        
                        <!-- Campo oculto: ID del paciente -->
                        <input type="hidden" name="paciente_id" value="{{ paciente.pk }}">

                        <!-- ============================================
                             SECCIÓN 1: Datos Generales del Embarazo
                             ============================================ -->
                        <div class="mb-4">
                            <h6 class="text-primary border-bottom pb-2 mb-3">
                                <i class="bi bi-1-circle"></i> Datos Generales del Embarazo
                            </h6>

                            <div class="row g-3">
                                <!-- Número de ficha (generado automáticamente) -->
                                <div class="col-md-6">
                                    {{ form.numero_ficha.label_tag }}
                                    {{ form.numero_ficha }}
                                    {% if form.numero_ficha.help_text %}
                                        <small class="form-text text-muted d-block">
                                            <i class="bi bi-info-circle"></i> {{ form.numero_ficha.help_text }}
                                        </small>
                                    {% endif %}
                                    {% if form.numero_ficha.errors %}
                                        <div class="text-danger small mt-1">
                                            {{ form.numero_ficha.errors }}
                                        </div>
                                    {% endif %}
                                </div>

                                <!-- Fecha probable de parto (FPP) -->
                                <div class="col-md-6">
                                    {{ form.fecha_probable_parto.label_tag }}
                                    {{ form.fecha_probable_parto }}
                                    {% if form.fecha_probable_parto.help_text %}
                                        <small class="form-text text-muted d-block">
                                            {{ form.fecha_probable_parto.help_text }}
                                        </small>
                                    {% endif %}
                                    {% if form.fecha_probable_parto.errors %}
                                        <div class="text-danger small mt-1">
                                            {{ form.fecha_probable_parto.errors }}
                                        </div>
                                    {% endif %}
                                </div>

                                <!-- Edad gestacional en semanas -->
                                <div class="col-md-6">
                                    {{ form.edad_gestacional_sem.label_tag }}
                                    {{ form.edad_gestacional_sem }}
                                    {% if form.edad_gestacional_sem.help_text %}
                                        <small class="form-text text-muted d-block">
                                            {{ form.edad_gestacional_sem.help_text }}
                                        </small>
                                    {% endif %}
                                    {% if form.edad_gestacional_sem.errors %}
                                        <div class="text-danger small mt-1">
                                            {{ form.edad_gestacional_sem.errors }}
                                        </div>
                                    {% endif %}
                                </div>

                                <!-- Peso pre-gestacional -->
                                <div class="col-md-6">
                                    {{ form.peso_pre_gestacional.label_tag }}
                                    <div class="input-group">
                                        {{ form.peso_pre_gestacional }}
                                        <span class="input-group-text">kg</span>
                                    </div>
                                    {% if form.peso_pre_gestacional.errors %}
                                        <div class="text-danger small mt-1">
                                            {{ form.peso_pre_gestacional.errors }}
                                        </div>
                                    {% endif %}
                                </div>

                                <!-- Talla de la paciente -->
                                <div class="col-md-6">
                                    {{ form.talla.label_tag }}
                                    <div class="input-group">
                                        {{ form.talla }}
                                        <span class="input-group-text">cm</span>
                                    </div>
                                    {% if form.talla.errors %}
                                        <div class="text-danger small mt-1">
                                            {{ form.talla.errors }}
                                        </div>
                                    {% endif %}
                                </div>

                                <!-- IMC (calculado automáticamente) -->
                                <div class="col-md-6">
                                    <label class="form-label">
                                        <i class="bi bi-calculator"></i> IMC (calculado)
                                    </label>
                                    <input 
                                        type="text" 
                                        class="form-control bg-light" 
                                        id="imc_display" 
                                        readonly 
                                        placeholder="Se calculará automáticamente"
                                    >
                                    <small class="form-text text-muted">
                                        Índice de Masa Corporal = Peso / (Talla²)
                                    </small>
                                </div>
                            </div>
                        </div>

                        <!-- ============================================
                             SECCIÓN 2: Antecedentes Obstétricos
                             ============================================ -->
                        <div class="mb-4">
                            <h6 class="text-primary border-bottom pb-2 mb-3">
                                <i class="bi bi-2-circle"></i> Antecedentes Obstétricos
                            </h6>

                            <div class="row g-3">
                                <!-- Gestas (número de embarazos) -->
                                <div class="col-md-3">
                                    {{ form.gestas.label_tag }}
                                    {{ form.gestas }}
                                    {% if form.gestas.help_text %}
                                        <small class="form-text text-muted d-block">
                                            {{ form.gestas.help_text }}
                                        </small>
                                    {% endif %}
                                </div>

                                <!-- Partos -->
                                <div class="col-md-3">
                                    {{ form.partos.label_tag }}
                                    {{ form.partos }}
                                </div>

                                <!-- Cesáreas -->
                                <div class="col-md-3">
                                    {{ form.cesareas.label_tag }}
                                    {{ form.cesareas }}
                                </div>

                                <!-- Abortos -->
                                <div class="col-md-3">
                                    {{ form.abortos.label_tag }}
                                    {{ form.abortos }}
                                </div>
                            </div>
                        </div>

                        <!-- ============================================
                             SECCIÓN 3: Datos del Acompañante
                             ============================================ -->
                        <div class="mb-4">
                            <h6 class="text-primary border-bottom pb-2 mb-3">
                                <i class="bi bi-3-circle"></i> Acompañante
                            </h6>

                            <div class="row g-3">
                                <div class="col-md-12">
                                    {{ form.nombre_acompanante.label_tag }}
                                    {{ form.nombre_acompanante }}
                                    {% if form.nombre_acompanante.help_text %}
                                        <small class="form-text text-muted d-block">
                                            {{ form.nombre_acompanante.help_text }}
                                        </small>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- ============================================
                             SECCIÓN 4: Observaciones y Antecedentes
                             ============================================ -->
                        <div class="mb-4">
                            <h6 class="text-primary border-bottom pb-2 mb-3">
                                <i class="bi bi-4-circle"></i> Observaciones y Antecedentes Médicos
                            </h6>

                            <!-- Observaciones generales -->
                            <div class="mb-3">
                                {{ form.observaciones_generales.label_tag }}
                                {{ form.observaciones_generales }}
                                {% if form.observaciones_generales.help_text %}
                                    <small class="form-text text-muted">
                                        {{ form.observaciones_generales.help_text }}
                                    </small>
                                {% endif %}
                            </div>

                            <!-- Antecedentes relevantes -->
                            <div class="mb-3">
                                {{ form.antecedentes_relevantes.label_tag }}
                                {{ form.antecedentes_relevantes }}
                                {% if form.antecedentes_relevantes.help_text %}
                                    <small class="form-text text-muted">
                                        {{ form.antecedentes_relevantes.help_text }}
                                    </small>
                                {% endif %}
                            </div>
                        </div>

                        <!-- ============================================
                             SECCIÓN: Botones de acción
                             ============================================ -->
                        <div class="d-flex justify-content-between align-items-center mt-4 pt-3 border-top">
                            <a href="{% url 'matrona:detalle_paciente' paciente.pk %}" 
                               class="btn btn-outline-secondary">
                                <i class="bi bi-x-circle"></i> Cancelar
                            </a>
                            
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="bi bi-check-circle"></i> Crear Ficha Obstétrica
                            </button>
                        </div>

                    </form>
                </div>
            </div>

            <!-- ============================================
                 CARD: Información adicional
                 ============================================ -->
            <div class="card shadow-sm mt-3">
                <div class="card-body bg-light">
                    <h6 class="text-muted">
                        <i class="bi bi-lightbulb"></i> Información Importante
                    </h6>
                    <ul class="mb-0 small">
                        <li>La ficha obstétrica se crea en estado <strong>Activo</strong> por defecto</li>
                        <li>Posteriormente podrá asignar patologías y medicamentos</li>
                        <li>La edad gestacional debe estar entre 0 y 42 semanas</li>
                        <li>Todos los campos marcados con * son obligatorios</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block extra_css %}
<style>
    /* Estilos para el formulario */
    
    /* Mejorar apariencia de inputs */
    .form-control, .form-select {
        border-radius: 0.375rem;
        border: 1px solid #ced4da;
        padding: 0.5rem 0.75rem;
    }
    
    .form-control:focus, .form-select:focus {
        border-color: #0d6efd;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }
    
    /* Labels con mejor formato */
    label.form-label {
        font-weight: 500;
        margin-bottom: 0.5rem;
        color: #495057;
    }
    
    /* Card sticky para información del paciente */
    @media (min-width: 992px) {
        .sticky-top {
            position: sticky;
            top: 20px;
            z-index: 1020;
        }
    }
    
    /* Mejorar secciones del formulario */
    .border-bottom {
        border-bottom: 2px solid #e9ecef !important;
    }
    
    /* Inputs de solo lectura */
    .bg-light.form-control {
        background-color: #e9ecef !important;
        cursor: not-allowed;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    // JavaScript para cálculo automático de IMC y validaciones
    
    document.addEventListener('DOMContentLoaded', function() {
        
        // Obtener elementos del formulario
        const inputPeso = document.getElementById('id_peso_pre_gestacional');
        const inputTalla = document.getElementById('id_talla');
        const displayIMC = document.getElementById('imc_display');
        
        // Función para calcular IMC
        function calcularIMC() {
            const peso = parseFloat(inputPeso.value);
            const talla = parseFloat(inputTalla.value);
            
            // Validar que ambos valores existan y sean válidos
            if (peso > 0 && talla > 0) {
                // Convertir talla de cm a metros
                const tallaMetros = talla / 100;
                
                // Calcular IMC = peso / (talla²)
                const imc = peso / (tallaMetros * tallaMetros);
                
                // Mostrar resultado con 2 decimales
                displayIMC.value = imc.toFixed(2);
                
                // Cambiar color según clasificación
                if (imc < 18.5) {
                    displayIMC.className = 'form-control bg-light text-warning';
                } else if (imc >= 18.5 && imc < 25) {
                    displayIMC.className = 'form-control bg-light text-success';
                } else if (imc >= 25 && imc < 30) {
                    displayIMC.className = 'form-control bg-light text-warning';
                } else {
                    displayIMC.className = 'form-control bg-light text-danger';
                }
            } else {
                displayIMC.value = '';
                displayIMC.className = 'form-control bg-light';
            }
        }
        
        // Event listeners para calcular IMC cuando cambian los valores
        if (inputPeso && inputTalla) {
            inputPeso.addEventListener('input', calcularIMC);
            inputTalla.addEventListener('input', calcularIMC);
            
            // Calcular al cargar si hay valores
            calcularIMC();
        }
        
        // Validación del formulario antes de enviar
        const form = document.getElementById('formFichaObstetrica');
        if (form) {
            form.addEventListener('submit', function(event) {
                // Validar edad gestacional
                const edadGest = document.getElementById('id_edad_gestacional_sem');
                if (edadGest) {
                    const valor = parseInt(edadGest.value);
                    if (valor < 0 || valor > 42) {
                        alert('La edad gestacional debe estar entre 0 y 42 semanas');
                        event.preventDefault();
                        edadGest.focus();
                        return false;
                    }
                }
            });
        }
        
        // Configurar datepicker para fecha probable de parto
        const inputFPP = document.getElementById('id_fecha_probable_parto');
        if (inputFPP) {
            inputFPP.type = 'date';
        }
    });
</script>
{% endblock %}
