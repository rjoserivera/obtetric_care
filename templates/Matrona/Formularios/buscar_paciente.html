{% extends 'Shared/base.html' %}
{% load static %}

{% block title %}Buscar Paciente - Sistema Obstétrico{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <!-- Header -->
            <div class="mb-4">
                <h2>
                    <i class="bi bi-search"></i>
                    Búsqueda de Pacientes
                </h2>
                <p class="text-muted">
                    Busque pacientes por RUT, nombre o número de ficha para acceder rápidamente a su información.
                </p>
            </div>
            
            <!-- Formulario de Búsqueda -->
            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    <form method="GET" id="form-busqueda">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label for="{{ form.buscar_por.id_for_label }}" class="form-label">
                                    {{ form.buscar_por.label }}
                                </label>
                                {{ form.buscar_por }}
                            </div>
                            
                            <div class="col-md-7">
                                <label for="{{ form.termino.id_for_label }}" class="form-label">
                                    {{ form.termino.label }}
                                </label>
                                {{ form.termino }}
                            </div>
                            
                            <div class="col-md-2 d-flex align-items-end">
                                <button type="submit" class="btn btn-primary w-100">
                                    <i class="bi bi-search"></i> Buscar
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Resultados de Búsqueda -->
            {% if resultados %}
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-list-ul"></i>
                        Resultados de Búsqueda ({{ resultados|length }})
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>RUT</th>
                                    <th>Nombre Completo</th>
                                    <th>Edad</th>
                                    <th>Previsión</th>
                                    <th>Última Ficha</th>
                                    <th class="text-center">Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for paciente in resultados %}
                                <tr>
                                    <td><strong>{{ paciente.persona.Rut }}</strong></td>
                                    <td>{{ paciente.persona.Nombre }} {{ paciente.persona.Apellido }}</td>
                                    <td>{{ paciente.Edad }} años</td>
                                    <td>
                                        <span class="badge bg-info">{{ paciente.Previcion }}</span>
                                    </td>
                                    <td>
                                        {% if paciente.ingresos.first %}
                                            {{ paciente.ingresos.first.numero_ficha }}
                                        {% else %}
                                            <span class="text-muted">Sin ingresos</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        <a href="{% url 'matrona:detalle_paciente' paciente.pk %}" 
                                           class="btn btn-sm btn-primary" title="Ver ficha completa">
                                            <i class="bi bi-file-medical"></i> Ficha
                                        </a>
                                        <a href="{% url 'matrona:historial_paciente' paciente.pk %}" 
                                           class="btn btn-sm btn-info" title="Ver historial">
                                            <i class="bi bi-clock-history"></i> Historial
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            {% elif request.GET.termino %}
            <div class="alert alert-warning text-center" role="alert">
                <i class="bi bi-exclamation-triangle fs-1"></i>
                <h4 class="mt-3">No se encontraron resultados</h4>
                <p>No se encontraron pacientes con el término de búsqueda: <strong>{{ request.GET.termino }}</strong></p>
                <p class="mb-0">Intente con otro criterio de búsqueda.</p>
            </div>
            {% endif %}
            
            <!-- Accesos Rápidos -->
            <div class="row mt-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body text-center">
                            <i class="bi bi-person-plus fs-1 text-primary"></i>
                            <h5 class="mt-3">Nuevo Paciente</h5>
                            <p class="text-muted">Registre un nuevo paciente en el sistema</p>
                            <a href="{% url 'matrona:registrar_paciente' %}" class="btn btn-primary">
                                <i class="bi bi-plus-circle"></i> Registrar Paciente
                            </a>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body text-center">
                            <i class="bi bi-door-open fs-1 text-success"></i>
                            <h5 class="mt-3">Nuevo Ingreso</h5>
                            <p class="text-muted">Registre el ingreso de una paciente</p>
                            <a href="{% url 'matrona:registrar_ingreso' %}" class="btn btn-success">
                                <i class="bi bi-plus-circle"></i> Registrar Ingreso
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Cambiar placeholder según tipo de búsqueda
    document.getElementById('buscar_por').addEventListener('change', function() {
        const termino = document.getElementById('termino_busqueda');
        
        switch(this.value) {
            case 'rut':
                termino.placeholder = 'Ejemplo: 12345678-9';
                break;
            case 'nombre':
                termino.placeholder = 'Ejemplo: María González';
                break;
            case 'ficha':
                termino.placeholder = 'Ejemplo: F-2025-0001';
                break;
        }
    });
</script>
{% endblock %}