{% extends 'Shared/base.html' %}
{% load static %}

{% block title %}Editar Ficha {{ ficha.numero_ficha }} - Sistema Obstétrico{% endblock %}

{% block content %}
<div class="container mt-4">
    
    <!-- ============================================
         SECCIÓN: Navegación (Breadcrumb)
         ============================================ -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                <a href="{% url 'matrona:menu_matrona' %}">
                    <i class="bi bi-house-fill"></i> Menú Matrona
                </a>
            </li>
            <li class="breadcrumb-item">
                <a href="{% url 'matrona:detalle_paciente' ficha.paciente.pk %}">
                    {{ ficha.paciente.persona.Nombre }} {{ ficha.paciente.persona.Apellido_Paterno }}
                </a>
            </li>
            <li class="breadcrumb-item">
                <a href="{% url 'matrona:detalle_ficha' ficha.pk %}">
                    Ficha {{ ficha.numero_ficha }}
                </a>
            </li>
            <li class="breadcrumb-item active" aria-current="page">
                Editar
            </li>
        </ol>
    </nav>

    <!-- ============================================
         SECCIÓN: Alerta si la ficha está cerrada
         ============================================ -->
    {% if not ficha.activa %}
        <div class="alert alert-warning" role="alert">
            <i class="bi bi-exclamation-triangle-fill"></i>
            <strong>¡Atención!</strong> Esta ficha está <strong>cerrada</strong>. 
            Si necesita realizar cambios, contacte al administrador del sistema.
        </div>
    {% endif %}

    <!-- ============================================
         SECCIÓN: Encabezado
         ============================================ -->
    <div class="row mb-4">
        <div class="col-12">
            <h2 class="text-primary">
                <i class="bi bi-pencil-square"></i> Editar Ficha Obstétrica
            </h2>
            <p class="text-muted">
                Ficha N° <strong>{{ ficha.numero_ficha }}</strong> - 
                Actualice los datos del embarazo actual
            </p>
        </div>
    </div>

    <div class="row">
        <!-- ============================================
             COLUMNA IZQUIERDA: Info del Paciente y Resumen
             ============================================ -->
        <div class="col-lg-4 mb-4">
            
            <!-- Card: Información del Paciente -->
            <div class="card shadow-sm sticky-top mb-3" style="top: 20px;">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-person-fill"></i> Datos del Paciente
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-2">
                        <small class="text-muted">Nombre:</small><br>
                        <strong>
                            {{ ficha.paciente.persona.Nombre }} 
                            {{ ficha.paciente.persona.Apellido_Paterno }}
                        </strong>
                    </div>
                    <div class="mb-2">
                        <small class="text-muted">RUT:</small><br>
                        <strong>{{ ficha.paciente.persona.Rut }}</strong>
                    </div>
                    <div class="mb-2">
                        <small class="text-muted">Edad:</small><br>
                        {{ ficha.paciente.Edad|default:"No registrada" }}
                    </div>
                    <div class="mb-2">
                        <small class="text-muted">Previsión:</small><br>
                        <span class="badge bg-info">
                            {{ ficha.paciente.Previcion|default:"No especificada" }}
                        </span>
                    </div>
                </div>
            </div>

            <!-- Card: Resumen de la Ficha -->
            <div class="card shadow-sm">
                <div class="card-header bg-secondary text-white">
                    <h6 class="mb-0">
                        <i class="bi bi-clipboard-data"></i> Resumen de la Ficha
                    </h6>
                </div>
                <div class="card-body">
                    <div class="mb-2">
                        <small class="text-muted">Fecha de creación:</small><br>
                        <strong>{{ ficha.fecha_creacion|date:"d/m/Y H:i" }}</strong>
                    </div>
                    <div class="mb-2">
                        <small class="text-muted">Última modificación:</small><br>
                        <strong>{{ ficha.fecha_modificacion|date:"d/m/Y H:i" }}</strong>
                    </div>
                    <div class="mb-2">
                        <small class="text-muted">Matrona responsable:</small><br>
                        <strong>
                            {{ ficha.matrona_responsable.persona.Nombre }} 
                            {{ ficha.matrona_responsable.persona.Apellido_Paterno }}
                        </strong>
                    </div>
                    <div class="mb-0">
                        <small class="text-muted">Estado:</small><br>
                        {% if ficha.activa %}
                            <span class="badge bg-success">
                                <i class="bi bi-check-circle"></i> Activa
                            </span>
                        {% else %}
                            <span class="badge bg-secondary">
                                <i class="bi bi-x-circle"></i> Cerrada
                            </span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- ============================================
             COLUMNA DERECHA: Formulario de Edición
             ============================================ -->
        <div class="col-lg-8">
            <div class="card shadow-sm">
                <div class="card-header bg-warning">
                    <h5 class="mb-0">
                        <i class="bi bi-pencil-fill"></i> Formulario de Edición
                    </h5>
                </div>
                <div class="card-body">
                    
                    <!-- Mostrar mensajes de error -->
                    {% if form.errors %}
                        <div class="alert alert-danger" role="alert">
                            <i class="bi bi-exclamation-triangle-fill"></i>
                            <strong>Error en el formulario</strong>
                            <ul class="mb-0 mt-2">
                                {% for field, errors in form.errors.items %}
                                    {% for error in errors %}
                                        <li>{{ error }}</li>
                                    {% endfor %}
                                {% endfor %}
                            </ul>
                        </div>
                    {% endif %}

                    <!-- Formulario de edición -->
                    <form method="POST" id="formEditarFicha">
                        {% csrf_token %}

                        <!-- ============================================
                             SECCIÓN 1: Datos del Embarazo
                             ============================================ -->
                        <div class="mb-4">
                            <h6 class="text-warning border-bottom pb-2 mb-3">
                                <i class="bi bi-1-circle"></i> Datos del Embarazo
                            </h6>

                            <div class="row g-3">
                                <!-- Número de ficha (solo lectura) -->
                                <div class="col-md-6">
                                    <label class="form-label">
                                        N° Ficha
                                    </label>
                                    <input 
                                        type="text" 
                                        class="form-control bg-light" 
                                        value="{{ ficha.numero_ficha }}" 
                                        readonly
                                    >
                                    <small class="text-muted">
                                        El número de ficha no se puede modificar
                                    </small>
                                </div>

                                <!-- Fecha Probable de Parto -->
                                <div class="col-md-6">
                                    {{ form.fecha_probable_parto.label_tag }}
                                    {{ form.fecha_probable_parto }}
                                    {% if form.fecha_probable_parto.errors %}
                                        <div class="text-danger small mt-1">
                                            {{ form.fecha_probable_parto.errors }}
                                        </div>
                                    {% endif %}
                                </div>

                                <!-- Edad gestacional -->
                                <div class="col-md-6">
                                    {{ form.edad_gestacional_sem.label_tag }}
                                    {{ form.edad_gestacional_sem }}
                                    {% if form.edad_gestacional_sem.help_text %}
                                        <small class="form-text text-muted d-block">
                                            {{ form.edad_gestacional_sem.help_text }}
                                        </small>
                                    {% endif %}
                                    {% if form.edad_gestacional_sem.errors %}
                                        <div class="text-danger small mt-1">
                                            {{ form.edad_gestacional_sem.errors }}
                                        </div>
                                    {% endif %}
                                </div>

                                <!-- Peso pre-gestacional -->
                                <div class="col-md-6">
                                    {{ form.peso_pre_gestacional.label_tag }}
                                    <div class="input-group">
                                        {{ form.peso_pre_gestacional }}
                                        <span class="input-group-text">kg</span>
                                    </div>
                                </div>

                                <!-- Talla -->
                                <div class="col-md-6">
                                    {{ form.talla.label_tag }}
                                    <div class="input-group">
                                        {{ form.talla }}
                                        <span class="input-group-text">cm</span>
                                    </div>
                                </div>

                                <!-- IMC calculado -->
                                <div class="col-md-6">
                                    <label class="form-label">
                                        <i class="bi bi-calculator"></i> IMC (calculado)
                                    </label>
                                    <input 
                                        type="text" 
                                        class="form-control bg-light" 
                                        id="imc_display" 
                                        readonly 
                                        placeholder="Se calculará automáticamente"
                                    >
                                </div>
                            </div>
                        </div>

                        <!-- ============================================
                             SECCIÓN 2: Antecedentes Obstétricos
                             ============================================ -->
                        <div class="mb-4">
                            <h6 class="text-warning border-bottom pb-2 mb-3">
                                <i class="bi bi-2-circle"></i> Antecedentes Obstétricos
                            </h6>

                            <div class="row g-3">
                                <div class="col-md-3">
                                    {{ form.gestas.label_tag }}
                                    {{ form.gestas }}
                                </div>
                                <div class="col-md-3">
                                    {{ form.partos.label_tag }}
                                    {{ form.partos }}
                                </div>
                                <div class="col-md-3">
                                    {{ form.cesareas.label_tag }}
                                    {{ form.cesareas }}
                                </div>
                                <div class="col-md-3">
                                    {{ form.abortos.label_tag }}
                                    {{ form.abortos }}
                                </div>
                            </div>
                        </div>

                        <!-- ============================================
                             SECCIÓN 3: Acompañante
                             ============================================ -->
                        <div class="mb-4">
                            <h6 class="text-warning border-bottom pb-2 mb-3">
                                <i class="bi bi-3-circle"></i> Acompañante
                            </h6>

                            <div class="row g-3">
                                <div class="col-12">
                                    {{ form.nombre_acompanante.label_tag }}
                                    {{ form.nombre_acompanante }}
                                </div>
                            </div>
                        </div>

                        <!-- ============================================
                             SECCIÓN 4: Observaciones
                             ============================================ -->
                        <div class="mb-4">
                            <h6 class="text-warning border-bottom pb-2 mb-3">
                                <i class="bi bi-4-circle"></i> Observaciones
                            </h6>

                            <div class="mb-3">
                                {{ form.observaciones_generales.label_tag }}
                                {{ form.observaciones_generales }}
                            </div>

                            <div class="mb-3">
                                {{ form.antecedentes_relevantes.label_tag }}
                                {{ form.antecedentes_relevantes }}
                            </div>
                        </div>

                        <!-- ============================================
                             SECCIÓN: Botones de acción
                             ============================================ -->
                        <div class="d-flex justify-content-between align-items-center mt-4 pt-3 border-top">
                            <div>
                                <a href="{% url 'matrona:detalle_ficha' ficha.pk %}" 
                                   class="btn btn-outline-secondary">
                                    <i class="bi bi-x-circle"></i> Cancelar
                                </a>
                            </div>
                            
                            <div>
                                {% if ficha.activa %}
                                    <button type="submit" class="btn btn-warning btn-lg">
                                        <i class="bi bi-save"></i> Guardar Cambios
                                    </button>
                                {% else %}
                                    <button type="button" class="btn btn-secondary btn-lg" disabled>
                                        <i class="bi bi-lock"></i> Ficha Cerrada
                                    </button>
                                {% endif %}
                            </div>
                        </div>

                    </form>
                </div>
            </div>

            <!-- Card: Historial de cambios -->
            <div class="card shadow-sm mt-3">
                <div class="card-body bg-light">
                    <h6 class="text-muted mb-2">
                        <i class="bi bi-clock-history"></i> Historial de Modificaciones
                    </h6>
                    <p class="mb-0 small">
                        <strong>Última modificación:</strong> 
                        {{ ficha.fecha_modificacion|date:"d/m/Y H:i" }}
                    </p>
                    <p class="mb-0 small text-muted">
                        <i class="bi bi-info-circle"></i>
                        Todos los cambios quedan registrados en el sistema
                    </p>
                </div>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block extra_css %}
<style>
    /* Estilos personalizados */
    
    .form-control, .form-select {
        border-radius: 0.375rem;
        border: 1px solid #ced4da;
    }
    
    .form-control:focus, .form-select:focus {
        border-color: #ffc107;
        box-shadow: 0 0 0 0.25rem rgba(255, 193, 7, 0.25);
    }
    
    label.form-label {
        font-weight: 500;
        color: #495057;
    }
    
    .border-bottom {
        border-bottom: 2px solid #e9ecef !important;
    }
    
    @media (min-width: 992px) {
        .sticky-top {
            position: sticky;
            top: 20px;
            z-index: 1020;
        }
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    // JavaScript para cálculo de IMC y validaciones
    
    document.addEventListener('DOMContentLoaded', function() {
        
        // Obtener elementos
        const inputPeso = document.getElementById('id_peso_pre_gestacional');
        const inputTalla = document.getElementById('id_talla');
        const displayIMC = document.getElementById('imc_display');
        
        // Función para calcular IMC
        function calcularIMC() {
            const peso = parseFloat(inputPeso.value);
            const talla = parseFloat(inputTalla.value);
            
            if (peso > 0 && talla > 0) {
                const tallaMetros = talla / 100;
                const imc = peso / (tallaMetros * tallaMetros);
                
                displayIMC.value = imc.toFixed(2);
                
                // Clasificación visual del IMC
                if (imc < 18.5) {
                    displayIMC.className = 'form-control bg-light text-info';
                } else if (imc >= 18.5 && imc < 25) {
                    displayIMC.className = 'form-control bg-light text-success';
                } else if (imc >= 25 && imc < 30) {
                    displayIMC.className = 'form-control bg-light text-warning';
                } else {
                    displayIMC.className = 'form-control bg-light text-danger';
                }
            } else {
                displayIMC.value = '';
                displayIMC.className = 'form-control bg-light';
            }
        }
        
        // Event listeners
        if (inputPeso && inputTalla) {
            inputPeso.addEventListener('input', calcularIMC);
            inputTalla.addEventListener('input', calcularIMC);
            
            // Calcular al cargar
            calcularIMC();
        }
        
        // Validación del formulario
        const form = document.getElementById('formEditarFicha');
        if (form) {
            form.addEventListener('submit', function(event) {
                const edadGest = document.getElementById('id_edad_gestacional_sem');
                if (edadGest) {
                    const valor = parseInt(edadGest.value);
                    if (valor < 0 || valor > 42) {
                        alert('La edad gestacional debe estar entre 0 y 42 semanas');
                        event.preventDefault();
                        edadGest.focus();
                        return false;
                    }
                }
            });
        }
        
        // Configurar datepicker
        const inputFPP = document.getElementById('id_fecha_probable_parto');
        if (inputFPP) {
            inputFPP.type = 'date';
        }

        // Confirmación de cambios si la ficha está activa
        {% if ficha.activa %}
        form.addEventListener('submit', function(e) {
            if (!confirm('¿Está seguro de que desea guardar los cambios en esta ficha?')) {
                e.preventDefault();
            }
        });
        {% endif %}
    });
</script>
{% endblock %}
