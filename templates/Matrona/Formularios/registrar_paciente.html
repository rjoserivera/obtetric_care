{% extends 'Shared/base.html' %}
{% load static %}

{% block title %}Registrar Paciente - Sistema Obstétrico{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Encabezado -->
    <div class="row mb-4">
        <div class="col-12">
            <h2 class="text-success">
                <i class="bi bi-person-plus-fill"></i> Registrar Nuevo Paciente
            </h2>
            <hr>
        </div>
    </div>

    <!-- Formulario de Registro -->
    <div class="card shadow-sm">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0"><i class="bi bi-person-lines-fill"></i> Datos del Paciente</h5>
        </div>
        <div class="card-body">
            <form method="post" id="formRegistrarPaciente">
                {% csrf_token %}
                
                <!-- Mostrar errores -->
                {% if form.errors %}
                <div class="alert alert-danger" role="alert">
                    <h5><i class="bi bi-exclamation-triangle"></i> Corrija los siguientes errores:</h5>
                    {{ form.errors }}
                </div>
                {% endif %}

                <!-- Datos Personales -->
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h6 class="mb-0">👤 Información Personal</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <!-- RUT -->
                            <div class="col-md-6 mb-3">
                                <label for="id_rut" class="form-label">
                                    RUT <span class="text-danger">*</span>
                                </label>
                                {{ form.rut }}
                                <small class="form-text text-muted">Formato: 12345678-9</small>
                                <button type="button" class="btn btn-sm btn-outline-primary mt-1" id="btnBuscarRut">
                                    <i class="bi bi-search"></i> Buscar RUT
                                </button>
                            </div>

                            <!-- Nombres -->
                            <div class="col-md-6 mb-3">
                                <label for="id_nombre" class="form-label">
                                    Nombres <span class="text-danger">*</span>
                                </label>
                                {{ form.nombre }}
                            </div>

                            <!-- Apellido Paterno -->
                            <div class="col-md-6 mb-3">
                                <label for="id_apellido_paterno" class="form-label">
                                    Apellido Paterno <span class="text-danger">*</span>
                                </label>
                                {{ form.apellido_paterno }}
                            </div>

                            <!-- Apellido Materno -->
                            <div class="col-md-6 mb-3">
                                <label for="id_apellido_materno" class="form-label">
                                    Apellido Materno <span class="text-danger">*</span>
                                </label>
                                {{ form.apellido_materno }}
                            </div>

                            <!-- Fecha de Nacimiento -->
                            <div class="col-md-6 mb-3">
                                <label for="id_fecha_nacimiento" class="form-label">
                                    Fecha de Nacimiento <span class="text-danger">*</span>
                                </label>
                                {{ form.fecha_nacimiento }}
                            </div>

                            <!-- Sexo -->
                            <div class="col-md-6 mb-3">
                                <label for="id_sexo" class="form-label">
                                    Sexo <span class="text-danger">*</span>
                                </label>
                                {{ form.sexo }}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Datos de Contacto -->
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h6 class="mb-0">📞 Información de Contacto</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <!-- Teléfono -->
                            <div class="col-md-6 mb-3">
                                <label for="id_telefono" class="form-label">
                                    Teléfono <span class="text-danger">*</span>
                                </label>
                                {{ form.telefono }}
                                <small class="form-text text-muted">Ej: +56912345678</small>
                            </div>

                            <!-- Email -->
                            <div class="col-md-6 mb-3">
                                <label for="id_email" class="form-label">
                                    Email
                                </label>
                                {{ form.email }}
                            </div>

                            <!-- Dirección -->
                            <div class="col-md-12 mb-3">
                                <label for="id_direccion" class="form-label">
                                    Dirección <span class="text-danger">*</span>
                                </label>
                                {{ form.direccion }}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Datos Médicos Básicos -->
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h6 class="mb-0">🩺 Información Médica</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <!-- Prevision -->
                            <div class="col-md-6 mb-3">
                                <label for="id_prevision" class="form-label">
                                    Previsión <span class="text-danger">*</span>
                                </label>
                                {{ form.prevision }}
                            </div>

                            <!-- Alergias -->
                            <div class="col-md-6 mb-3">
                                <label for="id_alergias" class="form-label">
                                    Alergias Conocidas
                                </label>
                                {{ form.alergias }}
                                <small class="form-text text-muted">Medicamentos, alimentos, etc.</small>
                            </div>

                            <!-- Grupo Sanguíneo -->
                            <div class="col-md-6 mb-3">
                                <label for="id_grupo_sanguineo" class="form-label">
                                    Grupo Sanguíneo
                                </label>
                                {{ form.grupo_sanguineo }}
                            </div>

                            <!-- Factor RH -->
                            <div class="col-md-6 mb-3">
                                <label for="id_factor_rh" class="form-label">
                                    Factor RH
                                </label>
                                {{ form.factor_rh }}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Contacto de Emergencia -->
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h6 class="mb-0">🚨 Contacto de Emergencia</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <!-- Nombre del Acompañante -->
                            <div class="col-md-6 mb-3">
                                <label for="id_acompanante" class="form-label">
                                    Nombre del Acompañante
                                </label>
                                {{ form.acompanante }}
                            </div>

                            <!-- Teléfono de Emergencia -->
                            <div class="col-md-6 mb-3">
                                <label for="id_contacto_emergencia" class="form-label">
                                    Teléfono de Emergencia <span class="text-danger">*</span>
                                </label>
                                {{ form.contacto_emergencia }}
                                <small class="form-text text-muted">Contacto en caso de emergencia</small>
                            </div>

                            <!-- Relación con el Paciente -->
                            <div class="col-md-6 mb-3">
                                <label for="id_relacion_acompanante" class="form-label">
                                    Relación con el Paciente
                                </label>
                                {{ form.relacion_acompanante }}
                                <small class="form-text text-muted">Ej: Esposo, Madre, Hermana</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Observaciones -->
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h6 class="mb-0">📝 Observaciones</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-12 mb-3">
                                <label for="id_observaciones" class="form-label">
                                    Observaciones Generales
                                </label>
                                {{ form.observaciones }}
                                <small class="form-text text-muted">
                                    Antecedentes relevantes, condiciones especiales, etc.
                                </small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Botones de Acción -->
                <div class="row mt-4">
                    <div class="col-12">
                        <button type="submit" class="btn btn-success btn-lg">
                            <i class="bi bi-check-circle"></i> Registrar Paciente
                        </button>
                        <a href="{% url 'matrona:buscar_paciente' %}" class="btn btn-secondary btn-lg">
                            <i class="bi bi-x-circle"></i> Cancelar
                        </a>
                        <button type="reset" class="btn btn-outline-warning btn-lg">
                            <i class="bi bi-arrow-clockwise"></i> Limpiar Formulario
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Información Importante -->
    <div class="alert alert-info mt-4" role="alert">
        <h6><i class="bi bi-info-circle"></i> Información Importante</h6>
        <ul class="mb-0">
            <li>Los campos marcados con <span class="text-danger">*</span> son obligatorios</li>
            <li>El RUT debe ser válido y único en el sistema</li>
            <li>Verifique que todos los datos estén correctos antes de guardar</li>
            <li>Después del registro, podrá crear una ficha obstétrica para el paciente</li>
        </ul>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Validación de RUT chileno
function validarRut(rut) {
    rut = rut.replace(/\./g, '').replace(/-/g, '');
    if (rut.length < 2) return false;
    
    const cuerpo = rut.slice(0, -1);
    const dv = rut.slice(-1).toUpperCase();
    
    let suma = 0;
    let multiplo = 2;
    
    for (let i = cuerpo.length - 1; i >= 0; i--) {
        suma += parseInt(cuerpo.charAt(i)) * multiplo;
        multiplo = multiplo === 7 ? 2 : multiplo + 1;
    }
    
    const dvEsperado = 11 - (suma % 11);
    const dvCalculado = dvEsperado === 11 ? '0' : dvEsperado === 10 ? 'K' : dvEsperado.toString();
    
    return dv === dvCalculado;
}

// Buscar RUT (simulado - requiere implementación AJAX en producción)
document.getElementById('btnBuscarRut')?.addEventListener('click', function() {
    const rut = document.getElementById('id_rut').value;
    if (!rut) {
        alert('⚠️ Ingrese un RUT para buscar');
        return;
    }
    
    if (!validarRut(rut)) {
        alert('❌ El RUT ingresado no es válido');
        return;
    }
    
    // Aquí iría la llamada AJAX para buscar si existe la persona
    alert('✅ Buscando información del RUT... (Funcionalidad a implementar)');
});

// Validar formulario antes de enviar
document.getElementById('formRegistrarPaciente').addEventListener('submit', function(e) {
    const rut = document.getElementById('id_rut').value;
    
    if (!validarRut(rut)) {
        e.preventDefault();
        alert('❌ El RUT ingresado no es válido. Por favor verifique.');
        document.getElementById('id_rut').focus();
        return false;
    }
    
    // Validar edad mínima (debe ser mayor de edad para ser paciente obstétrica)
    const fechaNac = new Date(document.getElementById('id_fecha_nacimiento').value);
    const hoy = new Date();
    const edad = Math.floor((hoy - fechaNac) / (365.25 * 24 * 60 * 60 * 1000));
    
    if (edad < 12 || edad > 60) {
        const confirmacion = confirm(`⚠️ La edad calculada es ${edad} años. ¿Desea continuar?`);
        if (!confirmacion) {
            e.preventDefault();
            return false;
        }
    }
});

// Formatear RUT mientras se escribe
document.getElementById('id_rut')?.addEventListener('input', function(e) {
    let rut = this.value.replace(/\./g, '').replace(/-/g, '');
    if (rut.length > 1) {
        rut = rut.slice(0, -1) + '-' + rut.slice(-1);
    }
    this.value = rut;
});

console.log('✅ Formulario de registrar paciente cargado');
</script>
{% endblock %}