{% extends 'Shared/base.html' %}
{% load static %}

{% block title %}Detalle del Paciente - Sistema Obstétrico{% endblock %}

{% block content %}
<div class="container mt-4">
  <div class="card shadow">
    <!-- Header con badge y botón -->
    <div class="card-header bg-danger text-white">
      <h4 class="mb-0 d-flex align-items-center gap-2 w-100">
        <i class="bi bi-person-badge"></i> Ficha del Paciente

        {% if legacy_total and legacy_total|add:0 > 0 %}
          <span class="badge bg-light text-danger ms-2" title="Controles previos en base histórica">
            {{ legacy_total }} controles
          </span>
          <a class="btn btn-light btn-sm ms-auto"
             data-bs-toggle="collapse" href="#historialLegacy" role="button" aria-expanded="false"
             aria-controls="historialLegacy">
            <i class="bi bi-clipboard2-pulse"></i> Ver controles previos
          </a>
        {% endif %}
      </h4>
    </div>

    <div class="card-body">
      <div class="row">
        <!-- Datos Personales -->
        <div class="col-md-6 mb-3">
          <h5 class="text-danger border-bottom pb-2">Datos Personales</h5>
          <p>
            <strong>RUT:</strong> {{ paciente.persona.Rut }}
            {% if legacy_total and legacy_total|add:0 > 0 %}
              <span class="badge bg-danger ms-2">Historial previo</span>
            {% endif %}
          </p>
          <p><strong>Nombre Completo:</strong> {{ paciente.persona.Nombre }} {{ paciente.persona.Apellido }}</p>
          <p><strong>Sexo:</strong> {{ paciente.persona.Sexo }}</p>
          <p><strong>Fecha Nacimiento:</strong> {{ paciente.persona.Fecha_nacimiento|date:"d/m/Y" }}</p>
          <p><strong>Teléfono:</strong> {{ paciente.persona.Telefono|default:"No registrado" }}</p>
          <p><strong>Email:</strong> {{ paciente.persona.Email|default:"No registrado" }}</p>
          <p><strong>Dirección:</strong> {{ paciente.persona.Direccion|default:"No registrada" }}</p>
        </div>

        <!-- Datos del Paciente -->
        <div class="col-md-6 mb-3">
          <h5 class="text-danger border-bottom pb-2">Datos Obstétricos</h5>
          <p><strong>Edad:</strong> {{ paciente.Edad }} años</p>
          <p><strong>Estado Civil:</strong> {{ paciente.get_Estado_civil_display }}</p>
          <p><strong>Previsión:</strong> {{ paciente.get_Previcion_display }}</p>
          <p><strong>Acompañante:</strong> {{ paciente.Acompañante|default:"No registrado" }}</p>
          <p><strong>Contacto Emergencia:</strong> {{ paciente.Contacto_emergencia|default:"No registrado" }}</p>
          <p><strong>Fecha Registro:</strong> {{ paciente.fecha_creacion|date:"d/m/Y H:i" }}</p>
        </div>
      </div>

      <hr>

      <div class="alert alert-info">
        <i class="bi bi-info-circle"></i>
        <strong>Nota:</strong> Para agregar ingresos, patologías y tratamientos, utilice las opciones del menú de matrona.
      </div>

      <!-- ====== Historial LEGACY: CONTROLES PREVIOS (sin JS, selección por ?ctrl=ID) ====== -->
      <hr>
      <div class="d-flex justify-content-between align-items-center mt-2">
        <h5 class="text-danger mb-0">
          <i class="bi bi-clipboard2-pulse"></i> Controles de Rutina Previos (LEGACY)
          {% if legacy_total is not None %}
            <span class="badge bg-secondary ms-2">{{ legacy_total|default:"0" }}</span>
          {% endif %}
        </h5>

        <button class="btn btn-outline-danger"
                type="button"
                data-bs-toggle="collapse"
                data-bs-target="#historialLegacy"
                aria-expanded="false"
                aria-controls="historialLegacy">
          <i class="bi bi-folder2-open"></i> Ver/Ocultar
        </button>
      </div>

      <div class="collapse {% if legacy_total and legacy_total|add:0 > 0 %}show{% endif %} mt-3" id="historialLegacy">
        <div class="card border-danger">
          <div class="card-header bg-light d-flex justify-content-between align-items-center">
            <div class="text-muted small">
              <i class="bi bi-database-gear"></i>
              Fuente: {{ legacy_fuente }}
              <span class="ms-2">RUT consultado: {{ paciente.persona.Rut }}</span>
            </div>
            <a class="btn btn-sm btn-outline-secondary" href="#historialLegacy"
               data-bs-toggle="collapse" data-bs-target="#historialLegacy">
              <i class="bi bi-x"></i> Cerrar
            </a>
          </div>

          <div class="card-body">
            {% if legacy_error %}
              <div class="alert alert-warning">
                <i class="bi bi-exclamation-triangle"></i>
                No fue posible consultar la base histórica en este momento.
              </div>
            {% elif legacy_total|add:0 == 0 %}
              <div class="alert alert-info">
                <i class="bi bi-info-circle"></i> No se encontraron controles previos para este RUT.
              </div>
            {% else %}

            <div class="row">
              <!-- IZQUIERDA: listado de fechas (enlaces con ?ctrl=ID) -->
              <div class="col-md-4 mb-3">
                <div class="list-group">
                  {% for c in legacy_controles %}
                  <a class="list-group-item list-group-item-action d-flex justify-content-between align-items-center {% if c.id == legacy_selected_id %}active{% endif %}"
                     href="?ctrl={{ c.id }}#historialLegacy">
                    <div>
                      <strong>{{ c.fecha_control|date:"d-m-Y" }}</strong>
                      <div class="small {% if c.id == legacy_selected_id %}text-white-50{% else %}text-muted{% endif %}">
                        EG: {{ c.semanas_gestacion|default:"—" }} sem
                        {% if c.presion_sistolica or c.presion_diastolica %}
                          · PA: {{ c.presion_sistolica|default:"-" }}/{{ c.presion_diastolica|default:"-" }}
                        {% endif %}
                      </div>
                    </div>
                    <i class="bi bi-chevron-right"></i>
                  </a>
                  {% endfor %}
                </div>
              </div>

              <!-- DERECHA: detalle del control seleccionado -->
              <div class="col-md-8">
                {% if legacy_selected %}
                <div class="table-responsive">
                  <table class="table table-sm table-striped align-middle mb-0">
                    <tbody>
                      <tr>
                        <th style="width:220px;">Fecha de control</th>
                        <td>{{ legacy_selected.fecha_control|date:"d-m-Y" }}</td>
                      </tr>
                      <tr>
                        <th>Edad gestacional (semanas)</th>
                        <td>{{ legacy_selected.semanas_gestacion|default:"—" }}</td>
                      </tr>
                      <tr>
                        <th>Presión arterial (mmHg)</th>
                        <td>
                          {% if legacy_selected.presion_sistolica or legacy_selected.presion_diastolica %}
                            {{ legacy_selected.presion_sistolica|default:"-" }}/{{ legacy_selected.presion_diastolica|default:"-" }}
                          {% else %}—{% endif %}
                        </td>
                      </tr>
                      <tr>
                        <th>Peso (kg)</th>
                        <td>{{ legacy_selected.peso_kg|default:"—" }}</td>
                      </tr>
                      <tr>
                        <th>Altura uterina (cm)</th>
                        <td>{{ legacy_selected.altura_uterina_cm|default:"—" }}</td>
                      </tr>
                      <tr>
                        <th>FCF (lpm)</th>
                        <td>{{ legacy_selected.fcf_lpm|default:"—" }}</td>
                      </tr>
                      <tr>
                        <th>Glucosa (mg/dL)</th>
                        <td>{{ legacy_selected.glucosa_mg_dl|default:"—" }}</td>
                      </tr>
                      <tr>
                        <th>Proteinuria</th>
                        <td>{{ legacy_selected.proteinuria|default:"—" }}</td>
                      </tr>
                      <tr>
                        <th>Observaciones</th>
                        <td>{{ legacy_selected.observaciones|default:"—" }}</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
                {% else %}
                  <div class="alert alert-info mb-0">Selecciona un control a la izquierda.</div>
                {% endif %}
              </div>
            </div>

            {% endif %}
          </div>
        </div>
      </div>
      <!-- ====== /LEGACY CONTROLES ====== -->

    </div>
  </div>

  <div class="mt-3">
    <a href="{% url 'matrona:lista_pacientes' %}" class="btn btn-secondary">
      <i class="bi bi-arrow-left"></i> Volver a la Lista
    </a>
    <a href="{% url 'matrona:buscar_paciente' %}" class="btn btn-outline-secondary">
      <i class="bi bi-search"></i> Buscar Otro Paciente
    </a>
  </div>
</div>
{% endblock %}



